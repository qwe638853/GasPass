<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasPass 簡單測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GasPass 簡單測試頁面</h1>
        
        <div class="section">
            <h3>1. 檢查環境</h3>
            <button onclick="checkEnvironment()">檢查環境</button>
            <div id="envStatus"></div>
        </div>

        <div class="section">
            <h3>2. 連接錢包</h3>
            <button onclick="connectWallet()">連接 MetaMask</button>
            <div id="walletStatus"></div>
        </div>

        <div class="section">
            <h3>3. 檢查合約狀態</h3>
            <button onclick="checkContract()">檢查合約</button>
            <div id="contractStatus"></div>
        </div>

        <div class="section">
            <h3>4. Mint GasPass Token</h3>
            <input type="number" id="mintAmount" placeholder="輸入 USDC 數量" value="10" min="1">
            <button onclick="mintToken()">Mint GasPass Token</button>
            <div id="mintStatus"></div>
        </div>

        <div class="section">
            <h3>5. 測試 Monitor</h3>
            <button onclick="testMonitor()">測試監聽</button>
            <div id="monitorStatus"></div>
        </div>
    </div>

    <script>
        // 檢查環境
        function checkEnvironment() {
            const envStatus = document.getElementById('envStatus');
            let status = '<div class="info">檢查中...</div>';
            envStatus.innerHTML = status;

            setTimeout(() => {
                let checks = [];
                
                // 檢查 ethers
                if (typeof ethers !== 'undefined') {
                    checks.push('✅ ethers.js 已載入');
                } else {
                    checks.push('❌ ethers.js 未載入');
                }

                // 檢查 MetaMask
                if (typeof window.ethereum !== 'undefined') {
                    checks.push('✅ MetaMask 已安裝');
                } else {
                    checks.push('❌ MetaMask 未安裝');
                }

                // 檢查網路
                if (typeof window.ethereum !== 'undefined') {
                    window.ethereum.request({ method: 'eth_chainId' }).then(chainId => {
                        if (chainId === '0xaef3') {
                            checks.push('✅ 已連接到 Arbitrum Sepolia');
                        } else {
                            checks.push('❌ 請切換到 Arbitrum Sepolia 網路');
                        }
                        envStatus.innerHTML = '<div class="info">' + checks.join('<br>') + '</div>';
                    });
                } else {
                    envStatus.innerHTML = '<div class="info">' + checks.join('<br>') + '</div>';
                }
            }, 1000);
        }

        // 連接錢包
        async function connectWallet() {
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.innerHTML = '<div class="info">連接中...</div>';

            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('請安裝 MetaMask 錢包');
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) {
                    throw new Error('用戶拒絕連接錢包');
                }

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== '0xaef3') {
                    throw new Error('請切換到 Arbitrum Sepolia 網路');
                }

                walletStatus.innerHTML = '<div class="success">✅ 錢包連接成功！<br>地址: ' + accounts[0] + '</div>';
            } catch (error) {
                walletStatus.innerHTML = '<div class="error">❌ 連接失敗: ' + error.message + '</div>';
            }
        }

        // 檢查合約
        async function checkContract() {
            const contractStatus = document.getElementById('contractStatus');
            contractStatus.innerHTML = '<div class="info">檢查合約中...</div>';

            try {
                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js 未載入');
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contractAddress = "0x9A6a09191dDf21CB5a123101d26eA6273a3E274b";
                
                // 檢查合約是否有代碼
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    throw new Error('合約地址沒有代碼');
                }

                // 簡單的合約調用
                const abi = ["function totalSupply() view returns (uint256)"];
                const contract = new ethers.Contract(contractAddress, abi, provider);
                const totalSupply = await contract.totalSupply();

                contractStatus.innerHTML = '<div class="success">✅ 合約檢查成功！<br>Total Supply: ' + totalSupply.toString() + '</div>';
            } catch (error) {
                contractStatus.innerHTML = '<div class="error">❌ 合約檢查失敗: ' + error.message + '</div>';
            }
        }

        // Mint GasPass Token
        async function mintToken() {
            const mintStatus = document.getElementById('mintStatus');
            const amount = document.getElementById('mintAmount').value;
            
            if (!amount || amount <= 0) {
                mintStatus.innerHTML = '<div class="error">❌ 請輸入有效的 USDC 數量</div>';
                return;
            }

            mintStatus.innerHTML = '<div class="info">Minting 中...</div>';

            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const contractAddress = "0x6F2997d9929C1b4eAF49F7fe4F4Dc12A5588D6d6";
                const usdcAddress = "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d";
                
                // USDC ABI
                const usdcAbi = [
                    "function balanceOf(address) view returns (uint256)",
                    "function approve(address, uint256) returns (bool)",
                    "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external"
                ];
                
                // GasPass ABI
                const gasPassAbi = [
                    "function mintWithSig(uint256 amount, uint256 nonce, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external",
                    "function totalSupply() view returns (uint256)"
                ];
                
                const usdcContract = new ethers.Contract(usdcAddress, usdcAbi, signer);
                const gasPassContract = new ethers.Contract(contractAddress, gasPassAbi, signer);
                
                // 檢查 USDC 餘額
                const usdcBalance = await usdcContract.balanceOf(await signer.getAddress());
                const amountWei = ethers.utils.parseUnits(amount, 6); // USDC 有 6 位小數
                
                if (usdcBalance.lt(amountWei)) {
                    throw new Error('USDC 餘額不足');
                }
                
                // 先 approve USDC
                const approveTx = await usdcContract.approve(contractAddress, amountWei);
                await approveTx.wait();
                
                // 使用 permit 簽名 mint
                const nonce = Math.floor(Math.random() * 1000000);
                const deadline = Math.floor(Date.now() / 1000) + 3600; // 1 小時後過期
                
                // 創建 permit 簽名
                const domain = {
                    name: "USD Coin",
                    version: "2",
                    chainId: 421614,
                    verifyingContract: usdcAddress
                };
                
                const types = {
                    Permit: [
                        { name: "owner", type: "address" },
                        { name: "spender", type: "address" },
                        { name: "value", type: "uint256" },
                        { name: "nonce", type: "uint256" },
                        { name: "deadline", type: "uint256" }
                    ]
                };
                
                const value = {
                    owner: await signer.getAddress(),
                    spender: contractAddress,
                    value: amountWei,
                    nonce: nonce,
                    deadline: deadline
                };
                
                const signature = await signer._signTypedData(domain, types, value);
                const sig = ethers.utils.splitSignature(signature);
                
                // 調用 mintWithSig
                const mintTx = await gasPassContract.mintWithSig(
                    amountWei,
                    nonce,
                    deadline,
                    sig.v,
                    sig.r,
                    sig.s
                );
                
                await mintTx.wait();
                
                // 檢查結果
                const totalSupply = await gasPassContract.totalSupply();
                
                mintStatus.innerHTML = '<div class="success">✅ Mint 成功！<br>Transaction: ' + mintTx.hash + '<br>Total Supply: ' + totalSupply.toString() + '</div>';
            } catch (error) {
                mintStatus.innerHTML = '<div class="error">❌ Mint 失敗: ' + error.message + '</div>';
            }
        }

        // 測試 Monitor
        async function testMonitor() {
            const monitorStatus = document.getElementById('monitorStatus');
            monitorStatus.innerHTML = '<div class="info">測試監聽中...</div>';

            try {
                // 模擬 monitor.js 的檢查邏輯
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contractAddress = "0x6F2997d9929C1b4eAF49F7fe4F4Dc12A5588D6d6";
                
                const abi = [
                    "function totalSupply() view returns (uint256)",
                    "function tokenByIndex(uint256) view returns (uint256)",
                    "function ownerOf(uint256) view returns (address)",
                    "function chainPolicies(uint256, uint256) view returns (uint128 gasAmount, uint128 threshold, address agent, uint256 lastRefueled)"
                ];
                
                const contract = new ethers.Contract(contractAddress, abi, provider);
                const totalSupply = await contract.totalSupply();
                
                let result = '✅ Monitor 測試成功！<br>';
                result += 'Total Supply: ' + totalSupply.toString() + '<br>';
                
                if (totalSupply.gt(0)) {
                    const tokenId = await contract.tokenByIndex(0);
                    const owner = await contract.ownerOf(tokenId);
                    result += 'Token #1 Owner: ' + owner + '<br>';
                    
                    // 檢查是否有策略
                    const policy = await contract.chainPolicies(tokenId, 84532); // Base Sepolia
                    if (policy.threshold.gt(0)) {
                        result += 'Token #1 有 Base Sepolia 策略<br>';
                        result += 'Threshold: ' + ethers.utils.formatEther(policy.threshold) + ' ETH<br>';
                    } else {
                        result += 'Token #1 沒有 Base Sepolia 策略<br>';
                    }
                } else {
                    result += '沒有 mint 任何 token<br>';
                }

                monitorStatus.innerHTML = '<div class="success">' + result + '</div>';
            } catch (error) {
                monitorStatus.innerHTML = '<div class="error">❌ Monitor 測試失敗: ' + error.message + '</div>';
            }
        }

        // 頁面載入時自動檢查環境
        window.onload = function() {
            checkEnvironment();
        };
    </script>

    <!-- 使用多個 CDN 備援 -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // 如果第一個 CDN 失敗，嘗試第二個
        if (typeof ethers === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
